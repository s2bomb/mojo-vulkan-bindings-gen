name: Nightly Deep Checks

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  deep-generation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test deps
        run: python -m pip install --upgrade pip pytest

      - name: Run full tests
        run: pytest tests tests/external

      - name: Clone Vulkan registries
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Docs.git /tmp/Vulkan-Docs
          git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Headers.git /tmp/Vulkan-Headers

      - name: Generate full bindings with all extensions
        run: |
          python gen.py --version 1.4 --all-extensions --vk-xml /tmp/Vulkan-Docs/xml/vk.xml --vulkan-headers /tmp/Vulkan-Headers/include --output-dir /tmp/vk_all_ext
          test -s /tmp/vk_all_ext/vk_structs.mojo
          test -s /tmp/vk_all_ext/vk_commands.mojo

      - name: Determinism gate (real registry)
        run: |
          python gen.py --version 1.3 --ext VK_KHR_surface VK_KHR_swapchain --vk-xml /tmp/Vulkan-Docs/xml/vk.xml --vulkan-headers /tmp/Vulkan-Headers/include --output-dir /tmp/vk_real_a
          python gen.py --version 1.3 --ext VK_KHR_surface VK_KHR_swapchain --vk-xml /tmp/Vulkan-Docs/xml/vk.xml --vulkan-headers /tmp/Vulkan-Headers/include --output-dir /tmp/vk_real_b
          diff -qr /tmp/vk_real_a /tmp/vk_real_b
