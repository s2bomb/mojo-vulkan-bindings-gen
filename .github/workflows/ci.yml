name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test-and-portability:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test deps
        run: python -m pip install --upgrade pip pytest

      - name: Run unit and external tests
        run: pytest tests tests/external

      - name: Determinism gate (fixture)
        run: |
          python gen.py --version 1.0 --vk-xml tests/fixtures/vk_minimal.xml --vulkan-headers tests/fixtures/fake_headers --output-dir /tmp/vkdet_a
          python gen.py --version 1.0 --vk-xml tests/fixtures/vk_minimal.xml --vulkan-headers tests/fixtures/fake_headers --output-dir /tmp/vkdet_b
          diff -qr /tmp/vkdet_a /tmp/vkdet_b

      - name: Real registry generate gate
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Docs.git /tmp/Vulkan-Docs
          git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Headers.git /tmp/Vulkan-Headers
          python gen.py --version 1.3 --vk-xml /tmp/Vulkan-Docs/xml/vk.xml --vulkan-headers /tmp/Vulkan-Headers/include --output-dir /tmp/vulkan-bindings
          test -f /tmp/vulkan-bindings/__init__.mojo
          test -f /tmp/vulkan-bindings/vk_base_types.mojo
          test -f /tmp/vulkan-bindings/vk_enums.mojo
          test -f /tmp/vulkan-bindings/vk_handles.mojo
          test -f /tmp/vulkan-bindings/vk_structs.mojo
          test -f /tmp/vulkan-bindings/vk_unions.mojo
          test -f /tmp/vulkan-bindings/vk_loader.mojo
          test -f /tmp/vulkan-bindings/vk_commands.mojo

  real-registry-version-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ["1.0", "1.1", "1.2", "1.3", "1.4"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Clone Vulkan registries
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Docs.git /tmp/Vulkan-Docs
          git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Headers.git /tmp/Vulkan-Headers

      - name: Generate real registry bindings (Vulkan ${{ matrix.version }})
        run: |
          out="/tmp/vulkan-bindings-${{ matrix.version }}"
          python gen.py --version "${{ matrix.version }}" --vk-xml /tmp/Vulkan-Docs/xml/vk.xml --vulkan-headers /tmp/Vulkan-Headers/include --output-dir "$out"
          test -f "$out/__init__.mojo"
          test -f "$out/vk_base_types.mojo"
          test -f "$out/vk_enums.mojo"
          test -f "$out/vk_handles.mojo"
          test -f "$out/vk_structs.mojo"
          test -f "$out/vk_unions.mojo"
          test -f "$out/vk_loader.mojo"
          test -f "$out/vk_commands.mojo"
